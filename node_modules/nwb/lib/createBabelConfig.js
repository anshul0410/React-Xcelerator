'use strict';

exports.__esModule = true;
exports.default = createBabelConfig;

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _utils = require('./utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var DEFAULT_STAGE = 2;

function createBabelConfig() {
  var buildConfig = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];
  var userConfig = arguments.length <= 1 || arguments[1] === undefined ? {} : arguments[1];
  var commonJSInterop = buildConfig.commonJSInterop;
  var env = buildConfig.env;
  var _buildConfig$modules = buildConfig.modules;
  var modules = _buildConfig$modules === undefined ? 'commonjs' : _buildConfig$modules;
  var _buildConfig$plugins = buildConfig.plugins;
  var buildPlugins = _buildConfig$plugins === undefined ? [] : _buildConfig$plugins;
  var buildPresets = buildConfig.presets;
  var _buildConfig$stage = buildConfig.stage;
  var buildStage = _buildConfig$stage === undefined ? DEFAULT_STAGE : _buildConfig$stage;
  var cherryPick = userConfig.cherryPick;
  var loose = userConfig.loose;
  var _userConfig$plugins = userConfig.plugins;
  var userPlugins = _userConfig$plugins === undefined ? [] : _userConfig$plugins;
  var userPresets = userConfig.presets;
  var userRuntime = userConfig.runtime;
  var userStage = userConfig.stage;


  var presets = [];
  var plugins = [];

  // Default to loose mode unless explicitly configured
  if ((0, _utils.typeOf)(loose) === 'undefined') {
    loose = true;
  }

  // ES2015 and ES2016 presets
  presets.push([require.resolve('babel-preset-es2015'), { loose: loose, modules: modules }], require.resolve('babel-preset-es2016'));

  // Stage preset
  var stage = userStage != null ? userStage : buildStage;
  if (typeof stage == 'number') {
    presets.push(require.resolve('babel-preset-stage-' + stage));
    // Decorators are stage 2 but not supported by Babel yet - add the legacy
    // transform for support in the meantime.
    if (stage <= 2) {
      plugins.push(require.resolve('babel-plugin-transform-decorators-legacy'));
    }
  }

  // Additional build presets
  if (Array.isArray(buildPresets)) {
    buildPresets.forEach(function (preset) {
      if (preset === 'react') {
        presets.push(require.resolve('babel-preset-react'));
        if (process.env.NODE_ENV === 'development') {
          plugins.push(require.resolve('babel-plugin-transform-react-jsx-source'), require.resolve('babel-plugin-transform-react-jsx-self'));
        }
      } else if (preset === 'react-hmre') {
        presets.push(require.resolve('../babel-presets/react-hmre'));
      } else if (preset === 'react-prod') {
        presets.push(require.resolve('../babel-presets/react-prod'));
      } else {
        throw new Error('Unknown build preset: ' + preset);
      }
    });
  }

  if (userPresets) {
    presets = [].concat(presets, userPresets);
  }

  var config = { presets: presets };

  plugins = plugins.concat(buildPlugins, userPlugins);

  // The Runtime transform imports various things into a module based on usage.
  // Turn regenerator on by default to enable use of async/await and generators
  // without configuration.
  var runtimeTransformOptions = {
    helpers: false,
    polyfill: false,
    regenerator: true,
    moduleName: _path2.default.dirname(require.resolve('babel-runtime/package'))
  };
  if (userRuntime !== false) {
    if (userRuntime === true) {
      // Enable all features
      runtimeTransformOptions = {
        moduleName: _path2.default.dirname(require.resolve('babel-runtime/package'))
      };
    } else if ((0, _utils.typeOf)(userRuntime) === 'string') {
      // Enable the named feature
      runtimeTransformOptions[userRuntime] = true;
    }
    plugins.push([require.resolve('babel-plugin-transform-runtime'), runtimeTransformOptions]);
  }

  // Provide CommonJS interop so require() in code-splitting require.ensure()
  // blocks doesn't need a .default tacked on the end.
  if (commonJSInterop) {
    plugins.push(require.resolve('babel-plugin-add-module-exports'));
  }

  // The lodash plugin supports generic cherry-picking for named modules
  if (cherryPick) {
    plugins.push([require.resolve('babel-plugin-lodash'), { id: cherryPick }]);
  }

  if (plugins.length > 0) {
    config.plugins = plugins;
  }

  // Pass any given env config through
  if (env) {
    config.env = env;
  }

  return config;
}
module.exports = exports['default'];