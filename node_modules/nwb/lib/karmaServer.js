'use strict';

exports.__esModule = true;
exports.default = karmaServer;

var _argvSetEnv = require('argv-set-env');

var _argvSetEnv2 = _interopRequireDefault(_argvSetEnv);

var _karma = require('karma');

var _createKarmaConfig = require('./createKarmaConfig');

var _createKarmaConfig2 = _interopRequireDefault(_createKarmaConfig);

var _errors = require('./errors');

var _getUserConfig = require('./getUserConfig');

var _getUserConfig2 = _interopRequireDefault(_getUserConfig);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function karmaServer(args, cb) {
  (0, _argvSetEnv2.default)();

  // Force the environment to test
  process.env.NODE_ENV = 'test';

  var isCi = process.env.CI || process.env.CONTINUOUS_INTEGRATION;

  var userConfig = (0, _getUserConfig2.default)(args);
  var karmaConfig = (0, _createKarmaConfig2.default)({
    codeCoverage: isCi || !!args.coverage,
    singleRun: isCi || !args.server
  }, userConfig);

  new _karma.Server(karmaConfig, function (exitCode) {
    if (exitCode !== 0) return cb(new _errors.KarmaExitCodeError(exitCode));
    cb();
  }).start();
}
module.exports = exports['default'];